From 7367c7cf5f4ca9ff9ddea142c2399032f32766b1 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sat, 31 Jan 2026 15:02:18 +0000
Subject: [PATCH] Add missing ModelConfig presets and fix config_map
 AttributeError

The /api/analyze endpoint always crashed with "ModelConfig has no attribute
'conservative_config'" because the config_map dictionary referenced three
classmethods (conservative_config, liberal_config, research_config) that
did not exist on ModelConfig. Python evaluates dict values at construction
time, so the endpoint failed regardless of which preset was requested.

Changes:
- core_model.py: Add conservative_config() and liberal_config() classmethods
  to ModelConfig with tuned parameters (faster/slower fatigue buildup,
  stricter/looser risk thresholds, worse/better sleep quality assumptions)
- api_server.py: Update config_map to include frontend preset names
  (easa-default, faa-standard, custom) alongside legacy names, and remove
  the non-existent research_config reference

https://claude.ai/code/session_013r8DZ7AaBv3M5UVdTtugs5
---
 api_server.py |  8 ++++---
 core_model.py | 64 +++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 69 insertions(+), 3 deletions(-)

diff --git a/api_server.py b/api_server.py
index 8d20eb6..3244c8c 100644
--- a/api_server.py
+++ b/api_server.py
@@ -69,7 +69,7 @@ class AnalysisRequest(BaseModel):
     month: str  # Format: "2026-02"
     home_base: str  # Airport code (e.g., "DOH")
     home_timezone: str  # e.g., "Asia/Qatar"
-    config_preset: str = "default"  # "default", "conservative", "liberal", "research"
+    config_preset: str = "default"  # "default"/"easa-default", "conservative"/"faa-standard", "liberal"/"custom"
 
 
 class DutySegmentResponse(BaseModel):
@@ -308,12 +308,14 @@ async def analyze_roster(
         if not roster.duties:
             raise HTTPException(status_code=400, detail="No duties found in roster")
         
-        # Get config
+        # Get config — map both legacy and frontend preset names
         config_map = {
             "default": ModelConfig.default_easa_config,
+            "easa-default": ModelConfig.default_easa_config,
             "conservative": ModelConfig.conservative_config,
+            "faa-standard": ModelConfig.conservative_config,
             "liberal": ModelConfig.liberal_config,
-            "research": ModelConfig.research_config
+            "custom": ModelConfig.liberal_config,
         }
         config_func = config_map.get(config_preset, ModelConfig.default_easa_config)
         config = config_func()
diff --git a/core_model.py b/core_model.py
index 950b3d1..28006d1 100644
--- a/core_model.py
+++ b/core_model.py
@@ -181,6 +181,70 @@ class ModelConfig:
             sleep_quality_params=SleepQualityParameters()
         )
 
+    @classmethod
+    def conservative_config(cls):
+        """Conservative configuration — assumes worse sleep quality and
+        faster homeostatic pressure buildup, yielding higher fatigue scores."""
+        return cls(
+            easa_framework=EASAFatigueFramework(),
+            borbely_params=BorbelyParameters(
+                tau_i=16.0,              # Faster fatigue buildup during wake
+                tau_d=4.8,               # Slower recovery during sleep
+                inertia_duration_minutes=40.0,
+                inertia_max_magnitude=0.35,
+                baseline_sleep_need_hours=8.5,
+            ),
+            risk_thresholds=RiskThresholds(thresholds={
+                'low': (80, 100),
+                'moderate': (70, 80),
+                'high': (60, 70),
+                'critical': (50, 60),
+                'extreme': (0, 50),
+            }),
+            adaptation_rates=AdaptationRates(
+                westward_hours_per_day=1.0,
+                eastward_hours_per_day=0.7,
+            ),
+            sleep_quality_params=SleepQualityParameters(
+                quality_hotel_quiet=0.80,
+                quality_hotel_typical=0.75,
+                quality_hotel_airport=0.65,
+                quality_crew_rest_facility=0.55,
+            ),
+        )
+
+    @classmethod
+    def liberal_config(cls):
+        """Liberal configuration — assumes better sleep quality and
+        slower homeostatic pressure buildup, yielding lower fatigue scores."""
+        return cls(
+            easa_framework=EASAFatigueFramework(),
+            borbely_params=BorbelyParameters(
+                tau_i=20.0,              # Slower fatigue buildup during wake
+                tau_d=3.8,               # Faster recovery during sleep
+                inertia_duration_minutes=20.0,
+                inertia_max_magnitude=0.25,
+                baseline_sleep_need_hours=7.5,
+            ),
+            risk_thresholds=RiskThresholds(thresholds={
+                'low': (70, 100),
+                'moderate': (60, 70),
+                'high': (50, 60),
+                'critical': (40, 50),
+                'extreme': (0, 40),
+            }),
+            adaptation_rates=AdaptationRates(
+                westward_hours_per_day=2.0,
+                eastward_hours_per_day=1.3,
+            ),
+            sleep_quality_params=SleepQualityParameters(
+                quality_hotel_quiet=0.90,
+                quality_hotel_typical=0.85,
+                quality_hotel_airport=0.80,
+                quality_crew_rest_facility=0.70,
+            ),
+        )
+
 
 # ============================================================================
 # SLEEP QUALITY ANALYSIS
-- 
2.43.0

